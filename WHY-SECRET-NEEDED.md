# ä¸ºä»€ä¹ˆéœ€è¦åˆ›å»º Kubernetes Secretï¼Ÿ

## ğŸ“‹ é—®é¢˜

åˆ›å»ºå®Œ DigitalOcean Spaces åï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦åˆ›å»º Kubernetes Secretï¼Ÿ

---

## ğŸ”‘ æ ¸å¿ƒåŸå› 

### Spaces å’Œ Secret çš„å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. DigitalOcean Spaces (å¯¹è±¡å­˜å‚¨)                        â”‚
â”‚    - å­˜å‚¨ Loki çš„æ—¥å¿—æ•°æ®                                â”‚
â”‚    - ç±»ä¼¼äº AWS S3 æˆ– Google Cloud Storage              â”‚
â”‚    - éœ€è¦èº«ä»½éªŒè¯æ‰èƒ½è®¿é—®                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ éœ€è¦è®¿é—®å‡­è¯
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Access Key + Secret Key (è®¿é—®å‡­è¯)                    â”‚
â”‚    - Access Key: ç±»ä¼¼ç”¨æˆ·å                              â”‚
â”‚    - Secret Key: ç±»ä¼¼å¯†ç                                 â”‚
â”‚    - ç”¨äºè¯æ˜"æˆ‘æ˜¯è°ï¼Œæˆ‘æœ‰æƒé™è®¿é—®è¿™ä¸ª Spaces"            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ éœ€è¦å®‰å…¨å­˜å‚¨
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Kubernetes Secret (å®‰å…¨å­˜å‚¨)                          â”‚
â”‚    - åœ¨ Kubernetes ä¸­å®‰å…¨å­˜å‚¨æ•æ„Ÿä¿¡æ¯                    â”‚
â”‚    - Loki Pod å¯ä»¥ä» Secret ä¸­è¯»å–è®¿é—®å‡­è¯               â”‚
â”‚    - ä¸ä¼šæš´éœ²åœ¨é…ç½®æ–‡ä»¶ä¸­                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ Pod å¯åŠ¨æ—¶è¯»å–
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Loki Pod (è¿è¡Œä¸­çš„å®¹å™¨)                               â”‚
â”‚    - ä» Secret è¯»å– Access Key å’Œ Secret Key           â”‚
â”‚    - ä½¿ç”¨è¿™äº›å‡­è¯è®¿é—® DigitalOcean Spaces               â”‚
â”‚    - å­˜å‚¨å’Œè¯»å–æ—¥å¿—æ•°æ®                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” è¯¦ç»†è§£é‡Š

### 1. DigitalOcean Spaces éœ€è¦èº«ä»½éªŒè¯

**ç±»æ¯”**ï¼šå°±åƒä½ çš„é“¶è¡Œè´¦æˆ·
- **Spaces** = é“¶è¡Œè´¦æˆ·ï¼ˆå­˜å‚¨æ•°æ®çš„åœ°æ–¹ï¼‰
- **Access Key** = è´¦æˆ·å·ç 
- **Secret Key** = å¯†ç 

**æ²¡æœ‰å‡­è¯å°±æ— æ³•è®¿é—®**ï¼š
```bash
# æ²¡æœ‰å‡­è¯ï¼Œæ— æ³•è®¿é—® Spaces
curl https://loki-storage-sgp1.sgp1.digitaloceanspaces.com
# è¿”å›: Access Denied
```

### 2. Loki éœ€è¦å‡­è¯æ¥è®¿é—® Spaces

Loki è¿è¡Œåœ¨ Kubernetes Pod ä¸­ï¼Œéœ€è¦ï¼š
- çŸ¥é“ Access Keyï¼ˆæˆ‘æ˜¯è°ï¼‰
- çŸ¥é“ Secret Keyï¼ˆæˆ‘çš„å¯†ç ï¼‰
- ä½¿ç”¨è¿™äº›å‡­è¯è®¿é—® Spaces

**é…ç½®ç¤ºä¾‹**ï¼š
```yaml
# Loki é…ç½®
loki:
  storage:
    type: s3
    s3:
      endpoint: sgp1.digitaloceanspaces.com
      accessKeyId: ???  # ä»å“ªé‡Œè·å–ï¼Ÿ
      secretAccessKey: ???  # ä»å“ªé‡Œè·å–ï¼Ÿ
```

### 3. ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥å†™åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Ÿ

**âŒ ä¸å®‰å…¨çš„æ–¹å¼**ï¼š
```yaml
# ç›´æ¥å†™åœ¨ values.yaml ä¸­ï¼ˆä¸å®‰å…¨ï¼ï¼‰
loki:
  storage:
    s3:
      accessKeyId: "DO1234567890ABCDEFGH"  # âŒ æ•æ„Ÿä¿¡æ¯æš´éœ²
      secretAccessKey: "abcdefghijklmnop..."  # âŒ æ•æ„Ÿä¿¡æ¯æš´éœ²
```

**é—®é¢˜**ï¼š
- âœ… é…ç½®æ–‡ä»¶ä¼šæäº¤åˆ° Git
- âœ… ä»»ä½•äººéƒ½èƒ½çœ‹åˆ°ä½ çš„è®¿é—®å‡­è¯
- âœ… å¦‚æœå‡­è¯æ³„éœ²ï¼Œåˆ«äººå¯ä»¥è®¿é—®ä½ çš„ Spaces
- âœ… è¿åå®‰å…¨æœ€ä½³å®è·µ

### 4. Kubernetes Secret çš„ä½œç”¨

**âœ… å®‰å…¨çš„æ–¹å¼**ï¼š
```yaml
# åœ¨ values.yaml ä¸­å¼•ç”¨ Secretï¼ˆå®‰å…¨ï¼‰
loki:
  storage:
    s3:
      accessKeyId:
        name: loki-spaces-credentials  # Secret åç§°
        key: AWS_ACCESS_KEY_ID          # Secret ä¸­çš„é”®
      secretAccessKey:
        name: loki-spaces-credentials   # Secret åç§°
        key: AWS_SECRET_ACCESS_KEY      # Secret ä¸­çš„é”®
```

**ä¼˜åŠ¿**ï¼š
- âœ… æ•æ„Ÿä¿¡æ¯ä¸å­˜å‚¨åœ¨é…ç½®æ–‡ä»¶ä¸­
- âœ… é…ç½®æ–‡ä»¶å¯ä»¥å®‰å…¨æäº¤åˆ° Git
- âœ… Secret åªåœ¨ Kubernetes é›†ç¾¤ä¸­å­˜å‚¨
- âœ… åªæœ‰æœ‰æƒé™çš„ç”¨æˆ·æ‰èƒ½æŸ¥çœ‹ Secret
- âœ… ç¬¦åˆå®‰å…¨æœ€ä½³å®è·µ

---

## ğŸ”„ å®Œæ•´æµç¨‹

### æ­¥éª¤ 1: åˆ›å»º Spaces
```
ä½  â†’ DigitalOcean æ§åˆ¶é¢æ¿ â†’ åˆ›å»º Spaces
ç»“æœ: æœ‰äº†å­˜å‚¨ç©ºé—´ï¼Œä½†æ²¡æœ‰è®¿é—®å‡­è¯
```

### æ­¥éª¤ 2: åˆ›å»ºè®¿é—®å¯†é’¥
```
ä½  â†’ DigitalOcean æ§åˆ¶é¢æ¿ â†’ ç”Ÿæˆ Access Key å’Œ Secret Key
ç»“æœ: æœ‰äº†è®¿é—®å‡­è¯ï¼Œä½†éœ€è¦å®‰å…¨å­˜å‚¨
```

### æ­¥éª¤ 3: åˆ›å»º Kubernetes Secret
```
ä½  â†’ kubectl create secret â†’ å°†å‡­è¯å­˜å‚¨åœ¨ Kubernetes ä¸­
ç»“æœ: å‡­è¯å®‰å…¨å­˜å‚¨åœ¨é›†ç¾¤ä¸­ï¼ŒLoki Pod å¯ä»¥è¯»å–
```

### æ­¥éª¤ 4: Loki Pod ä½¿ç”¨ Secret
```
Loki Pod å¯åŠ¨ â†’ ä» Secret è¯»å–å‡­è¯ â†’ ä½¿ç”¨å‡­è¯è®¿é—® Spaces â†’ å­˜å‚¨æ—¥å¿—
```

---

## ğŸ’¡ ç±»æ¯”ç†è§£

### ç±»æ¯” 1: é“¶è¡Œè´¦æˆ·

| æ¦‚å¿µ | é“¶è¡Œè´¦æˆ· | DigitalOcean Spaces |
|------|---------|-------------------|
| **å­˜å‚¨ä½ç½®** | é“¶è¡Œ | DigitalOcean Spaces |
| **è´¦æˆ·å·ç ** | é“¶è¡Œå¡å· | Access Key |
| **å¯†ç ** | é“¶è¡Œå¡å¯†ç  | Secret Key |
| **å®‰å…¨å­˜å‚¨** | è®°ä½å¯†ç ï¼ˆä¸å†™åœ¨çº¸ä¸Šï¼‰ | Kubernetes Secret |
| **ä½¿ç”¨** | ç”¨å¡å·å’Œå¯†ç å–é’± | ç”¨ Access Key å’Œ Secret Key è®¿é—® Spaces |

### ç±»æ¯” 2: å®¶é—¨é’¥åŒ™

| æ¦‚å¿µ | å®¶é—¨ | DigitalOcean Spaces |
|------|------|-------------------|
| **é—¨** | ä½ çš„æˆ¿å­ | Spaces å­˜å‚¨æ¡¶ |
| **é’¥åŒ™** | ç‰©ç†é’¥åŒ™ | Access Key + Secret Key |
| **é’¥åŒ™å­˜æ”¾** | æ”¾åœ¨å®‰å…¨çš„åœ°æ–¹ï¼ˆä¸éšä¾¿æ”¾ï¼‰ | Kubernetes Secret |
| **ä½¿ç”¨** | ç”¨é’¥åŒ™å¼€é—¨ | ç”¨å‡­è¯è®¿é—® Spaces |

---

## ğŸ“Š é…ç½®å¯¹æ¯”

### âŒ ä¸å®‰å…¨çš„æ–¹å¼ï¼ˆä¸æ¨èï¼‰

```yaml
# monitoring/values/loki-values-default.yaml
loki:
  storage:
    s3:
      accessKeyId: "DO1234567890ABCDEFGH"  # âŒ æš´éœ²åœ¨ Git ä¸­
      secretAccessKey: "abcdefghijklmnop..."  # âŒ æš´éœ²åœ¨ Git ä¸­
```

**é—®é¢˜**ï¼š
- é…ç½®æ–‡ä»¶æäº¤åˆ° Git åï¼Œä»»ä½•äººéƒ½èƒ½çœ‹åˆ°
- å¦‚æœä»“åº“æ˜¯å…¬å¼€çš„ï¼Œå‡­è¯å®Œå…¨æš´éœ²
- è¿åå®‰å…¨æœ€ä½³å®è·µ

### âœ… å®‰å…¨çš„æ–¹å¼ï¼ˆæ¨èï¼‰

```yaml
# monitoring/values/loki-values-default.yaml
loki:
  storage:
    s3:
      accessKeyId:
        name: loki-spaces-credentials  # âœ… å¼•ç”¨ Secret
        key: AWS_ACCESS_KEY_ID
      secretAccessKey:
        name: loki-spaces-credentials  # âœ… å¼•ç”¨ Secret
        key: AWS_SECRET_ACCESS_KEY
```

**ä¼˜åŠ¿**ï¼š
- é…ç½®æ–‡ä»¶å¯ä»¥å®‰å…¨æäº¤åˆ° Git
- æ•æ„Ÿä¿¡æ¯å­˜å‚¨åœ¨ Kubernetes Secret ä¸­
- åªæœ‰æœ‰æƒé™çš„ç”¨æˆ·æ‰èƒ½æŸ¥çœ‹ Secret

---

## ğŸ” Kubernetes Secret çš„å·¥ä½œåŸç†

### 1. Secret å­˜å‚¨åœ¨ etcd ä¸­

```
Kubernetes é›†ç¾¤
  â””â”€â”€ etcd (æ•°æ®åº“)
      â””â”€â”€ Secret: loki-spaces-credentials
          â”œâ”€â”€ AWS_ACCESS_KEY_ID: "DO123456..."
          â””â”€â”€ AWS_SECRET_ACCESS_KEY: "abcdef..."
```

### 2. Pod å¯åŠ¨æ—¶æŒ‚è½½ Secret

```yaml
# Loki Pod å¯åŠ¨æ—¶
apiVersion: v1
kind: Pod
spec:
  containers:
    - name: loki
      env:
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: loki-spaces-credentials
              key: AWS_ACCESS_KEY_ID
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: loki-spaces-credentials
              key: AWS_SECRET_ACCESS_KEY
```

### 3. Loki è¯»å–ç¯å¢ƒå˜é‡

```
Loki è¿›ç¨‹å¯åŠ¨
  â†’ è¯»å–ç¯å¢ƒå˜é‡ AWS_ACCESS_KEY_ID
  â†’ è¯»å–ç¯å¢ƒå˜é‡ AWS_SECRET_ACCESS_KEY
  â†’ ä½¿ç”¨è¿™äº›å‡­è¯è®¿é—® DigitalOcean Spaces
```

---

## ğŸ”„ AWS vs DigitalOcean: IAM Role æœºåˆ¶å¯¹æ¯”

### é—®é¢˜ï¼šDigitalOcean æœ‰ç±»ä¼¼ AWS IAM Role çš„æœºåˆ¶å—ï¼Ÿ

**ç®€çŸ­å›ç­”**ï¼š**ç›®å‰æ²¡æœ‰**ã€‚DigitalOcean ä¸æä¾›ç±»ä¼¼ AWS IAM Roles for Service Accounts (IRSA) çš„æœºåˆ¶ã€‚

---

### AWS IAM Role æœºåˆ¶ï¼ˆIRSAï¼‰

#### ä»€ä¹ˆæ˜¯ IRSAï¼Ÿ

**IAM Roles for Service Accounts (IRSA)** æ˜¯ AWS æä¾›çš„ä¸€ç§æœºåˆ¶ï¼Œå…è®¸ Kubernetes Service Account ç›´æ¥ä½¿ç”¨ IAM Roleï¼Œ**æ— éœ€å­˜å‚¨ Access Key å’Œ Secret Key**ã€‚

#### AWS IRSA å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. åˆ›å»º IAM Role                                         â”‚
â”‚    - å®šä¹‰è®¿é—® S3 çš„æƒé™ç­–ç•¥                               â”‚
â”‚    - ä¸éœ€è¦ Access Key/Secret Key                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ å…³è”åˆ° Service Account
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. é…ç½® Kubernetes Service Account                      â”‚
â”‚    - æ·»åŠ æ³¨è§£: eks.amazonaws.com/role-arn               â”‚
â”‚    - ä¸éœ€è¦ Secret                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ Pod ä½¿ç”¨ Service Account
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Pod è‡ªåŠ¨è·å–ä¸´æ—¶å‡­è¯                                  â”‚
â”‚    - AWS SDK è‡ªåŠ¨ä» STS è·å–ä¸´æ—¶å‡­è¯                     â”‚
â”‚    - å‡­è¯è‡ªåŠ¨è½®æ¢ï¼ˆæ›´å®‰å…¨ï¼‰                               â”‚
â”‚    - ä¸éœ€è¦æ‰‹åŠ¨ç®¡ç† Secret                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### AWS IRSA é…ç½®ç¤ºä¾‹

```yaml
# Service Account é…ç½®
apiVersion: v1
kind: ServiceAccount
metadata:
  name: loki-service-account
  namespace: monitoring
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/loki-s3-role
    # âœ… ä¸éœ€è¦ Access Key/Secret Key
    # âœ… ä¸éœ€è¦ Kubernetes Secret
```

```yaml
# Pod é…ç½®
apiVersion: v1
kind: Pod
spec:
  serviceAccountName: loki-service-account
  containers:
    - name: loki
      # âœ… AWS SDK è‡ªåŠ¨ä» IAM Role è·å–å‡­è¯
      # âœ… ä¸éœ€è¦ç¯å¢ƒå˜é‡
      # âœ… ä¸éœ€è¦ Secret æŒ‚è½½
```

#### AWS IRSA çš„ä¼˜åŠ¿

âœ… **æ— éœ€å­˜å‚¨å‡­è¯**
- ä¸éœ€è¦ Access Key/Secret Key
- ä¸éœ€è¦ Kubernetes Secret
- å‡­è¯è‡ªåŠ¨ç®¡ç†

âœ… **æ›´å®‰å…¨**
- ä¸´æ—¶å‡­è¯ï¼ˆè‡ªåŠ¨è¿‡æœŸï¼‰
- è‡ªåŠ¨è½®æ¢
- æœ€å°æƒé™åŸåˆ™

âœ… **æ›´ç®€å•**
- é…ç½®æ›´å°‘
- ä¸éœ€è¦æ‰‹åŠ¨åˆ›å»º Secret
- ä¸éœ€è¦æ›´æ–°å‡­è¯

---

### DigitalOcean çš„ç°çŠ¶

#### å½“å‰æœºåˆ¶

DigitalOcean **ç›®å‰ä¸æä¾›**ç±»ä¼¼ AWS IRSA çš„æœºåˆ¶ï¼š

âŒ **æ²¡æœ‰é›†ç¾¤çº§åˆ«çš„èº«ä»½**
- Kubernetes é›†ç¾¤æ²¡æœ‰"èº«ä»½"
- æ— æ³•è‡ªåŠ¨å…³è”åˆ° DigitalOcean èµ„æº

âŒ **æ²¡æœ‰ Service Account é›†æˆ**
- Service Account æ— æ³•ç›´æ¥ä½¿ç”¨ DigitalOcean API
- éœ€è¦æ‰‹åŠ¨åˆ›å»ºå’Œç®¡ç†å‡­è¯

âŒ **å¿…é¡»ä½¿ç”¨ Access Key/Secret Key**
- å¿…é¡»æ‰‹åŠ¨åˆ›å»º Spaces è®¿é—®å¯†é’¥
- å¿…é¡»å­˜å‚¨åœ¨ Kubernetes Secret ä¸­
- éœ€è¦æ‰‹åŠ¨è½®æ¢å‡­è¯

#### DigitalOcean å½“å‰å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ‰‹åŠ¨åˆ›å»º Spaces è®¿é—®å¯†é’¥                               â”‚
â”‚    - åœ¨ DigitalOcean æ§åˆ¶é¢æ¿åˆ›å»º                        â”‚
â”‚    - è·å– Access Key å’Œ Secret Key                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ æ‰‹åŠ¨åˆ›å»º Secret
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æ‰‹åŠ¨åˆ›å»º Kubernetes Secret                           â”‚
â”‚    - kubectl create secret                              â”‚
â”‚    - å­˜å‚¨ Access Key å’Œ Secret Key                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ Pod ä» Secret è¯»å–
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Pod ä½¿ç”¨ Secret ä¸­çš„å‡­è¯                              â”‚
â”‚    - ä» Secret è¯»å–å‡­è¯                                  â”‚
â”‚    - ä½¿ç”¨å‡­è¯è®¿é—® Spaces                                 â”‚
â”‚    - éœ€è¦æ‰‹åŠ¨ç®¡ç†å‡­è¯è½®æ¢                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### DigitalOcean çš„é™åˆ¶

| ç‰¹æ€§ | AWS (IRSA) | DigitalOcean |
|------|-----------|--------------|
| **é›†ç¾¤èº«ä»½** | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ |
| **Service Account é›†æˆ** | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ |
| **è‡ªåŠ¨å‡­è¯ç®¡ç†** | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ |
| **ä¸´æ—¶å‡­è¯** | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ |
| **å‡­è¯è½®æ¢** | âœ… è‡ªåŠ¨ | âŒ æ‰‹åŠ¨ |
| **éœ€è¦ Secret** | âŒ ä¸éœ€è¦ | âœ… å¿…é¡» |

---

### ä¸ºä»€ä¹ˆ DigitalOcean éœ€è¦ Secretï¼Ÿ

å› ä¸º DigitalOcean **æ²¡æœ‰**ç±»ä¼¼ AWS IRSA çš„æœºåˆ¶ï¼Œæ‰€ä»¥ï¼š

1. **å¿…é¡»æ‰‹åŠ¨åˆ›å»ºè®¿é—®å¯†é’¥**
   - åœ¨ DigitalOcean æ§åˆ¶é¢æ¿åˆ›å»º
   - è·å– Access Key å’Œ Secret Key

2. **å¿…é¡»å­˜å‚¨åœ¨ Kubernetes Secret ä¸­**
   - æ²¡æœ‰å…¶ä»–æ–¹å¼è®© Pod è·å–å‡­è¯
   - Secret æ˜¯å”¯ä¸€çš„å®‰å…¨å­˜å‚¨æ–¹å¼

3. **éœ€è¦æ‰‹åŠ¨ç®¡ç†å‡­è¯**
   - å®šæœŸè½®æ¢å‡­è¯
   - æ›´æ–° Secret
   - é‡å¯ Pod

---

### æœªæ¥å¯èƒ½çš„æ”¹è¿›

#### DigitalOcean çš„ RBAC å¢å¼ºï¼ˆ2024å¹´8æœˆï¼‰

DigitalOcean åœ¨ 2024å¹´8æœˆ å®£å¸ƒäº†**å¢å¼ºçš„åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰**åŠŸèƒ½ï¼š

- âœ… æä¾›é¢„å®šä¹‰è§’è‰²
- âœ… ç®€åŒ–ç”¨æˆ·è®¿é—®ç®¡ç†
- âš ï¸ **ä½†ä¸»è¦ç”¨äºç®¡ç†ç”¨æˆ·å¯¹ DigitalOcean èµ„æºçš„è®¿é—®æƒé™**
- âš ï¸ **ä¸æ˜¯ç”¨äº Kubernetes é›†ç¾¤å†…çš„ Service Account è‡ªåŠ¨è®¿é—® Spaces**

#### å¯èƒ½çš„æœªæ¥æ–¹å‘

è™½ç„¶ç›®å‰æ²¡æœ‰å®˜æ–¹æ”¯æŒï¼Œä½†æœªæ¥å¯èƒ½çš„æ–¹å‘åŒ…æ‹¬ï¼š

1. **é›†ç¾¤èº«ä»½é›†æˆ**
   - Kubernetes é›†ç¾¤è‡ªåŠ¨å…³è”åˆ° DigitalOcean è´¦æˆ·
   - Service Account å¯ä»¥ç»§æ‰¿é›†ç¾¤æƒé™

2. **Service Account æ³¨è§£æ”¯æŒ**
   - ç±»ä¼¼ AWS IRSA çš„æ³¨è§£æœºåˆ¶
   - è‡ªåŠ¨è·å–ä¸´æ—¶å‡­è¯

3. **Workload Identity**
   - ç±»ä¼¼ Google Cloud çš„ Workload Identity
   - Service Account ç›´æ¥ä½¿ç”¨ DigitalOcean API

---

### å¯¹æ¯”æ€»ç»“

| æ–¹é¢ | AWS (IRSA) | DigitalOcean (å½“å‰) |
|------|-----------|-------------------|
| **å‡­è¯ç®¡ç†** | è‡ªåŠ¨ | æ‰‹åŠ¨ |
| **å‡­è¯ç±»å‹** | ä¸´æ—¶å‡­è¯ | é•¿æœŸå‡­è¯ |
| **å‡­è¯è½®æ¢** | è‡ªåŠ¨ | æ‰‹åŠ¨ |
| **é…ç½®å¤æ‚åº¦** | ç®€å• | å¤æ‚ |
| **å®‰å…¨æ€§** | æ›´é«˜ | è¾ƒä½ |
| **éœ€è¦ Secret** | âŒ | âœ… |

---

### å®é™…å½±å“

#### å¯¹äºä½ çš„é¡¹ç›®

ç”±äº DigitalOcean ä¸æ”¯æŒç±»ä¼¼ AWS IRSA çš„æœºåˆ¶ï¼Œä½ å¿…é¡»ï¼š

1. âœ… **æ‰‹åŠ¨åˆ›å»º Spaces è®¿é—®å¯†é’¥**
2. âœ… **æ‰‹åŠ¨åˆ›å»º Kubernetes Secret**
3. âœ… **å®šæœŸè½®æ¢å‡­è¯**ï¼ˆå®‰å…¨æœ€ä½³å®è·µï¼‰
4. âœ… **æ›´æ–° Secret å’Œé‡å¯ Pod**ï¼ˆè½®æ¢æ—¶ï¼‰

#### å®‰å…¨å»ºè®®

è™½ç„¶éœ€è¦æ‰‹åŠ¨ç®¡ç†ï¼Œä½†ä½ å¯ä»¥ï¼š

1. **å®šæœŸè½®æ¢å‡­è¯**
   - æ¯ 90 å¤©è½®æ¢ä¸€æ¬¡
   - åˆ›å»ºæ–°å¯†é’¥åæ›´æ–° Secret
   - åˆ é™¤æ—§å¯†é’¥

2. **ä½¿ç”¨æœ€å°æƒé™åŸåˆ™**
   - åªæˆäºˆå¿…è¦çš„ Spaces è®¿é—®æƒé™
   - ä¸è¦ä½¿ç”¨å…¨å±€ç®¡ç†å‘˜å¯†é’¥

3. **ç›‘æ§è®¿é—®**
   - å®šæœŸæ£€æŸ¥ Spaces è®¿é—®æ—¥å¿—
   - å‘ç°å¼‚å¸¸åŠæ—¶å¤„ç†

---

## ğŸ¯ æ€»ç»“

### ä¸ºä»€ä¹ˆéœ€è¦ Secretï¼Ÿ

1. **å®‰å…¨å­˜å‚¨æ•æ„Ÿä¿¡æ¯**
   - Access Key å’Œ Secret Key æ˜¯æ•æ„Ÿä¿¡æ¯
   - ä¸èƒ½ç›´æ¥å†™åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼ˆä¼šæäº¤åˆ° Gitï¼‰
   - Secret æä¾›å®‰å…¨å­˜å‚¨æœºåˆ¶

2. **Loki éœ€è¦å‡­è¯è®¿é—® Spaces**
   - Spaces éœ€è¦èº«ä»½éªŒè¯
   - Loki Pod éœ€è¦å‡­è¯æ‰èƒ½è®¿é—®
   - Secret æ˜¯ Kubernetes ä¸­å­˜å‚¨å‡­è¯çš„æ ‡å‡†æ–¹å¼

3. **ç¬¦åˆå®‰å…¨æœ€ä½³å®è·µ**
   - æ•æ„Ÿä¿¡æ¯ä¸é…ç½®æ–‡ä»¶åˆ†ç¦»
   - é…ç½®æ–‡ä»¶å¯ä»¥å®‰å…¨æäº¤åˆ° Git
   - åªæœ‰æœ‰æƒé™çš„ç”¨æˆ·æ‰èƒ½è®¿é—® Secret

### å·¥ä½œæµç¨‹

```
åˆ›å»º Spaces
  â†“
åˆ›å»ºè®¿é—®å¯†é’¥ï¼ˆAccess Key + Secret Keyï¼‰
  â†“
åˆ›å»º Kubernetes Secretï¼ˆå®‰å…¨å­˜å‚¨å‡­è¯ï¼‰
  â†“
Loki Pod ä» Secret è¯»å–å‡­è¯
  â†“
ä½¿ç”¨å‡­è¯è®¿é—® Spaces
  â†“
å­˜å‚¨å’Œè¯»å–æ—¥å¿—æ•°æ®
```

---

## ğŸ“š å‚è€ƒ

- [Kubernetes Secrets æ–‡æ¡£](https://kubernetes.io/docs/concepts/configuration/secret/)
- [DigitalOcean Spaces è®¿é—®æ§åˆ¶](https://docs.digitalocean.com/products/spaces/how-to/access/)
- [Loki S3 å­˜å‚¨é…ç½®](https://grafana.com/docs/loki/latest/configuration/storage/)

---

**ç®€å•è¯´**ï¼šSecret å°±åƒæ˜¯ä¸€ä¸ª"ä¿é™©ç®±"ï¼Œç”¨æ¥å®‰å…¨å­˜å‚¨è®¿é—® Spaces çš„"é’¥åŒ™"ï¼ˆAccess Key å’Œ Secret Keyï¼‰ï¼ŒLoki Pod éœ€è¦è¿™äº›"é’¥åŒ™"æ‰èƒ½è®¿é—® Spaces å­˜å‚¨æ—¥å¿—æ•°æ®ã€‚

