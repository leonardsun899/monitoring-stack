# ä¸ºä»€ä¹ˆéœ€è¦åˆ›å»º Kubernetes Secretï¼Ÿ

## ğŸ“‹ é—®é¢˜

åˆ›å»ºå®Œ DigitalOcean Spaces åï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦åˆ›å»º Kubernetes Secretï¼Ÿ

---

## ğŸ”‘ æ ¸å¿ƒåŸå› 

### Spaces å’Œ Secret çš„å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. DigitalOcean Spaces (å¯¹è±¡å­˜å‚¨)                        â”‚
â”‚    - å­˜å‚¨ Loki çš„æ—¥å¿—æ•°æ®                                â”‚
â”‚    - ç±»ä¼¼äº AWS S3 æˆ– Google Cloud Storage              â”‚
â”‚    - éœ€è¦èº«ä»½éªŒè¯æ‰èƒ½è®¿é—®                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ éœ€è¦è®¿é—®å‡­è¯
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Access Key + Secret Key (è®¿é—®å‡­è¯)                    â”‚
â”‚    - Access Key: ç±»ä¼¼ç”¨æˆ·å                              â”‚
â”‚    - Secret Key: ç±»ä¼¼å¯†ç                                 â”‚
â”‚    - ç”¨äºè¯æ˜"æˆ‘æ˜¯è°ï¼Œæˆ‘æœ‰æƒé™è®¿é—®è¿™ä¸ª Spaces"            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ éœ€è¦å®‰å…¨å­˜å‚¨
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Kubernetes Secret (å®‰å…¨å­˜å‚¨)                          â”‚
â”‚    - åœ¨ Kubernetes ä¸­å®‰å…¨å­˜å‚¨æ•æ„Ÿä¿¡æ¯                    â”‚
â”‚    - Loki Pod å¯ä»¥ä» Secret ä¸­è¯»å–è®¿é—®å‡­è¯               â”‚
â”‚    - ä¸ä¼šæš´éœ²åœ¨é…ç½®æ–‡ä»¶ä¸­                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ Pod å¯åŠ¨æ—¶è¯»å–
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Loki Pod (è¿è¡Œä¸­çš„å®¹å™¨)                               â”‚
â”‚    - ä» Secret è¯»å– Access Key å’Œ Secret Key           â”‚
â”‚    - ä½¿ç”¨è¿™äº›å‡­è¯è®¿é—® DigitalOcean Spaces               â”‚
â”‚    - å­˜å‚¨å’Œè¯»å–æ—¥å¿—æ•°æ®                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” è¯¦ç»†è§£é‡Š

### 1. DigitalOcean Spaces éœ€è¦èº«ä»½éªŒè¯

**ç±»æ¯”**ï¼šå°±åƒä½ çš„é“¶è¡Œè´¦æˆ·
- **Spaces** = é“¶è¡Œè´¦æˆ·ï¼ˆå­˜å‚¨æ•°æ®çš„åœ°æ–¹ï¼‰
- **Access Key** = è´¦æˆ·å·ç 
- **Secret Key** = å¯†ç 

**æ²¡æœ‰å‡­è¯å°±æ— æ³•è®¿é—®**ï¼š
```bash
# æ²¡æœ‰å‡­è¯ï¼Œæ— æ³•è®¿é—® Spaces
curl https://loki-storage-sgp1.sgp1.digitaloceanspaces.com
# è¿”å›: Access Denied
```

### 2. Loki éœ€è¦å‡­è¯æ¥è®¿é—® Spaces

Loki è¿è¡Œåœ¨ Kubernetes Pod ä¸­ï¼Œéœ€è¦ï¼š
- çŸ¥é“ Access Keyï¼ˆæˆ‘æ˜¯è°ï¼‰
- çŸ¥é“ Secret Keyï¼ˆæˆ‘çš„å¯†ç ï¼‰
- ä½¿ç”¨è¿™äº›å‡­è¯è®¿é—® Spaces

**é…ç½®ç¤ºä¾‹**ï¼š
```yaml
# Loki é…ç½®
loki:
  storage:
    type: s3
    s3:
      endpoint: sgp1.digitaloceanspaces.com
      accessKeyId: ???  # ä»å“ªé‡Œè·å–ï¼Ÿ
      secretAccessKey: ???  # ä»å“ªé‡Œè·å–ï¼Ÿ
```

### 3. ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥å†™åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Ÿ

**âŒ ä¸å®‰å…¨çš„æ–¹å¼**ï¼š
```yaml
# ç›´æ¥å†™åœ¨ values.yaml ä¸­ï¼ˆä¸å®‰å…¨ï¼ï¼‰
loki:
  storage:
    s3:
      accessKeyId: "DO1234567890ABCDEFGH"  # âŒ æ•æ„Ÿä¿¡æ¯æš´éœ²
      secretAccessKey: "abcdefghijklmnop..."  # âŒ æ•æ„Ÿä¿¡æ¯æš´éœ²
```

**é—®é¢˜**ï¼š
- âœ… é…ç½®æ–‡ä»¶ä¼šæäº¤åˆ° Git
- âœ… ä»»ä½•äººéƒ½èƒ½çœ‹åˆ°ä½ çš„è®¿é—®å‡­è¯
- âœ… å¦‚æœå‡­è¯æ³„éœ²ï¼Œåˆ«äººå¯ä»¥è®¿é—®ä½ çš„ Spaces
- âœ… è¿åå®‰å…¨æœ€ä½³å®è·µ

### 4. Kubernetes Secret çš„ä½œç”¨

**âœ… å®‰å…¨çš„æ–¹å¼**ï¼š
```yaml
# åœ¨ values.yaml ä¸­å¼•ç”¨ Secretï¼ˆå®‰å…¨ï¼‰
loki:
  storage:
    s3:
      accessKeyId:
        name: loki-spaces-credentials  # Secret åç§°
        key: AWS_ACCESS_KEY_ID          # Secret ä¸­çš„é”®
      secretAccessKey:
        name: loki-spaces-credentials   # Secret åç§°
        key: AWS_SECRET_ACCESS_KEY      # Secret ä¸­çš„é”®
```

**ä¼˜åŠ¿**ï¼š
- âœ… æ•æ„Ÿä¿¡æ¯ä¸å­˜å‚¨åœ¨é…ç½®æ–‡ä»¶ä¸­
- âœ… é…ç½®æ–‡ä»¶å¯ä»¥å®‰å…¨æäº¤åˆ° Git
- âœ… Secret åªåœ¨ Kubernetes é›†ç¾¤ä¸­å­˜å‚¨
- âœ… åªæœ‰æœ‰æƒé™çš„ç”¨æˆ·æ‰èƒ½æŸ¥çœ‹ Secret
- âœ… ç¬¦åˆå®‰å…¨æœ€ä½³å®è·µ

---

## ğŸ”„ å®Œæ•´æµç¨‹

### æ­¥éª¤ 1: åˆ›å»º Spaces
```
ä½  â†’ DigitalOcean æ§åˆ¶é¢æ¿ â†’ åˆ›å»º Spaces
ç»“æœ: æœ‰äº†å­˜å‚¨ç©ºé—´ï¼Œä½†æ²¡æœ‰è®¿é—®å‡­è¯
```

### æ­¥éª¤ 2: åˆ›å»ºè®¿é—®å¯†é’¥
```
ä½  â†’ DigitalOcean æ§åˆ¶é¢æ¿ â†’ ç”Ÿæˆ Access Key å’Œ Secret Key
ç»“æœ: æœ‰äº†è®¿é—®å‡­è¯ï¼Œä½†éœ€è¦å®‰å…¨å­˜å‚¨
```

### æ­¥éª¤ 3: åˆ›å»º Kubernetes Secret
```
ä½  â†’ kubectl create secret â†’ å°†å‡­è¯å­˜å‚¨åœ¨ Kubernetes ä¸­
ç»“æœ: å‡­è¯å®‰å…¨å­˜å‚¨åœ¨é›†ç¾¤ä¸­ï¼ŒLoki Pod å¯ä»¥è¯»å–
```

### æ­¥éª¤ 4: Loki Pod ä½¿ç”¨ Secret
```
Loki Pod å¯åŠ¨ â†’ ä» Secret è¯»å–å‡­è¯ â†’ ä½¿ç”¨å‡­è¯è®¿é—® Spaces â†’ å­˜å‚¨æ—¥å¿—
```

---

## ğŸ’¡ ç±»æ¯”ç†è§£

### ç±»æ¯” 1: é“¶è¡Œè´¦æˆ·

| æ¦‚å¿µ | é“¶è¡Œè´¦æˆ· | DigitalOcean Spaces |
|------|---------|-------------------|
| **å­˜å‚¨ä½ç½®** | é“¶è¡Œ | DigitalOcean Spaces |
| **è´¦æˆ·å·ç ** | é“¶è¡Œå¡å· | Access Key |
| **å¯†ç ** | é“¶è¡Œå¡å¯†ç  | Secret Key |
| **å®‰å…¨å­˜å‚¨** | è®°ä½å¯†ç ï¼ˆä¸å†™åœ¨çº¸ä¸Šï¼‰ | Kubernetes Secret |
| **ä½¿ç”¨** | ç”¨å¡å·å’Œå¯†ç å–é’± | ç”¨ Access Key å’Œ Secret Key è®¿é—® Spaces |

### ç±»æ¯” 2: å®¶é—¨é’¥åŒ™

| æ¦‚å¿µ | å®¶é—¨ | DigitalOcean Spaces |
|------|------|-------------------|
| **é—¨** | ä½ çš„æˆ¿å­ | Spaces å­˜å‚¨æ¡¶ |
| **é’¥åŒ™** | ç‰©ç†é’¥åŒ™ | Access Key + Secret Key |
| **é’¥åŒ™å­˜æ”¾** | æ”¾åœ¨å®‰å…¨çš„åœ°æ–¹ï¼ˆä¸éšä¾¿æ”¾ï¼‰ | Kubernetes Secret |
| **ä½¿ç”¨** | ç”¨é’¥åŒ™å¼€é—¨ | ç”¨å‡­è¯è®¿é—® Spaces |

---

## ğŸ“Š é…ç½®å¯¹æ¯”

### âŒ ä¸å®‰å…¨çš„æ–¹å¼ï¼ˆä¸æ¨èï¼‰

```yaml
# monitoring/values/loki-values-default.yaml
loki:
  storage:
    s3:
      accessKeyId: "DO1234567890ABCDEFGH"  # âŒ æš´éœ²åœ¨ Git ä¸­
      secretAccessKey: "abcdefghijklmnop..."  # âŒ æš´éœ²åœ¨ Git ä¸­
```

**é—®é¢˜**ï¼š
- é…ç½®æ–‡ä»¶æäº¤åˆ° Git åï¼Œä»»ä½•äººéƒ½èƒ½çœ‹åˆ°
- å¦‚æœä»“åº“æ˜¯å…¬å¼€çš„ï¼Œå‡­è¯å®Œå…¨æš´éœ²
- è¿åå®‰å…¨æœ€ä½³å®è·µ

### âœ… å®‰å…¨çš„æ–¹å¼ï¼ˆæ¨èï¼‰

```yaml
# monitoring/values/loki-values-default.yaml
loki:
  storage:
    s3:
      accessKeyId:
        name: loki-spaces-credentials  # âœ… å¼•ç”¨ Secret
        key: AWS_ACCESS_KEY_ID
      secretAccessKey:
        name: loki-spaces-credentials  # âœ… å¼•ç”¨ Secret
        key: AWS_SECRET_ACCESS_KEY
```

**ä¼˜åŠ¿**ï¼š
- é…ç½®æ–‡ä»¶å¯ä»¥å®‰å…¨æäº¤åˆ° Git
- æ•æ„Ÿä¿¡æ¯å­˜å‚¨åœ¨ Kubernetes Secret ä¸­
- åªæœ‰æœ‰æƒé™çš„ç”¨æˆ·æ‰èƒ½æŸ¥çœ‹ Secret

---

## ğŸ” Kubernetes Secret çš„å·¥ä½œåŸç†

### 1. Secret å­˜å‚¨åœ¨ etcd ä¸­

```
Kubernetes é›†ç¾¤
  â””â”€â”€ etcd (æ•°æ®åº“)
      â””â”€â”€ Secret: loki-spaces-credentials
          â”œâ”€â”€ AWS_ACCESS_KEY_ID: "DO123456..."
          â””â”€â”€ AWS_SECRET_ACCESS_KEY: "abcdef..."
```

### 2. Pod å¯åŠ¨æ—¶æŒ‚è½½ Secret

```yaml
# Loki Pod å¯åŠ¨æ—¶
apiVersion: v1
kind: Pod
spec:
  containers:
    - name: loki
      env:
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              name: loki-spaces-credentials
              key: AWS_ACCESS_KEY_ID
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: loki-spaces-credentials
              key: AWS_SECRET_ACCESS_KEY
```

### 3. Loki è¯»å–ç¯å¢ƒå˜é‡

```
Loki è¿›ç¨‹å¯åŠ¨
  â†’ è¯»å–ç¯å¢ƒå˜é‡ AWS_ACCESS_KEY_ID
  â†’ è¯»å–ç¯å¢ƒå˜é‡ AWS_SECRET_ACCESS_KEY
  â†’ ä½¿ç”¨è¿™äº›å‡­è¯è®¿é—® DigitalOcean Spaces
```

---

## ğŸ¯ æ€»ç»“

### ä¸ºä»€ä¹ˆéœ€è¦ Secretï¼Ÿ

1. **å®‰å…¨å­˜å‚¨æ•æ„Ÿä¿¡æ¯**
   - Access Key å’Œ Secret Key æ˜¯æ•æ„Ÿä¿¡æ¯
   - ä¸èƒ½ç›´æ¥å†™åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼ˆä¼šæäº¤åˆ° Gitï¼‰
   - Secret æä¾›å®‰å…¨å­˜å‚¨æœºåˆ¶

2. **Loki éœ€è¦å‡­è¯è®¿é—® Spaces**
   - Spaces éœ€è¦èº«ä»½éªŒè¯
   - Loki Pod éœ€è¦å‡­è¯æ‰èƒ½è®¿é—®
   - Secret æ˜¯ Kubernetes ä¸­å­˜å‚¨å‡­è¯çš„æ ‡å‡†æ–¹å¼

3. **ç¬¦åˆå®‰å…¨æœ€ä½³å®è·µ**
   - æ•æ„Ÿä¿¡æ¯ä¸é…ç½®æ–‡ä»¶åˆ†ç¦»
   - é…ç½®æ–‡ä»¶å¯ä»¥å®‰å…¨æäº¤åˆ° Git
   - åªæœ‰æœ‰æƒé™çš„ç”¨æˆ·æ‰èƒ½è®¿é—® Secret

### å·¥ä½œæµç¨‹

```
åˆ›å»º Spaces
  â†“
åˆ›å»ºè®¿é—®å¯†é’¥ï¼ˆAccess Key + Secret Keyï¼‰
  â†“
åˆ›å»º Kubernetes Secretï¼ˆå®‰å…¨å­˜å‚¨å‡­è¯ï¼‰
  â†“
Loki Pod ä» Secret è¯»å–å‡­è¯
  â†“
ä½¿ç”¨å‡­è¯è®¿é—® Spaces
  â†“
å­˜å‚¨å’Œè¯»å–æ—¥å¿—æ•°æ®
```

---

## ğŸ“š å‚è€ƒ

- [Kubernetes Secrets æ–‡æ¡£](https://kubernetes.io/docs/concepts/configuration/secret/)
- [DigitalOcean Spaces è®¿é—®æ§åˆ¶](https://docs.digitalocean.com/products/spaces/how-to/access/)
- [Loki S3 å­˜å‚¨é…ç½®](https://grafana.com/docs/loki/latest/configuration/storage/)

---

**ç®€å•è¯´**ï¼šSecret å°±åƒæ˜¯ä¸€ä¸ª"ä¿é™©ç®±"ï¼Œç”¨æ¥å®‰å…¨å­˜å‚¨è®¿é—® Spaces çš„"é’¥åŒ™"ï¼ˆAccess Key å’Œ Secret Keyï¼‰ï¼ŒLoki Pod éœ€è¦è¿™äº›"é’¥åŒ™"æ‰èƒ½è®¿é—® Spaces å­˜å‚¨æ—¥å¿—æ•°æ®ã€‚

